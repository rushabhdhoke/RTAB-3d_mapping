# RTAB-Map Optimized Configuration for D435i
# Reduces noise and improves 3D mapping quality

# ==========================================
# VISUAL PROCESSING - Noise Reduction
# ==========================================
# Feature detection and matching
Vis/CorType=1                    # 0=FAST, 1=ORB, 2=BRIEF, 3=SURF, 4=SIFT
Vis/MaxFeatures=1000            # Increase features for better matching
Vis/MinInliers=15               # Minimum inliers for valid loop closure
Vis/InlierDistance=5            # Inlier distance threshold (lower = stricter)
Vis/EstimationType=1            # 0=3D->3D, 1=3D->2D (PnP), 2=2D->2D
Vis/PnPRefineIterations=3       # Refine pose estimation iterations
Vis/RoiRatios=0.1 0.1 0.1 0.1   # Region of interest ratios (reduce edges)

# ==========================================
# MEMORY MANAGEMENT
# ==========================================
Rtabmap/DetectionRate=3.0       # Process every 3rd frame (reduce computation)
Rtabmap/TimeThr=0                # Time threshold (0=disabled)
Rtabmap/MemoryThr=0              # Memory threshold (0=disabled)
Rtabmap/LoopThr=0.15             # Loop closure threshold (higher = fewer closures)
Rtabmap/LoopRatio=0.5            # Loop closure ratio
Rtabmap/ImagesAlreadyExtracted=true  # Skip feature extraction if already done

# ==========================================
# ODOMETRY - Improve tracking
# ==========================================
Odom/Strategy=0                  # 0=Frame-to-Map, 1=Frame-to-Frame
Odom/ResetCountdown=10           # Reset odometry if lost
Odom/InlierDistance=5            # Inlier distance for odometry
Odom/Iterations=200              # Iterations for optimization
Odom/RefineIterations=10         # Refinement iterations
Odom/LinearUpdate=0.5            # Update linear velocity threshold
Odom/AngularUpdate=0.5           # Update angular velocity threshold

# ==========================================
# REGISTRATION - Point cloud alignment
# ==========================================
Icp/Strategy=1                   # 0=Point-to-point, 1=Point-to-plane
Icp/Iterations=50                # ICP iterations
Icp/MaxTranslation=2.0           # Max translation (meters)
Icp/MaxRotation=0.3              # Max rotation (radians)
Icp/OutlierRatio=0.55            # Outlier ratio
Icp/CorrespondenceRatio=0.01     # Correspondence ratio
Icp/PointToPlaneK=20             # Point-to-plane K nearest neighbors
Icp/PointToPlaneRadius=0.2       # Point-to-plane radius

# ==========================================
# NOISE FILTERING
# ==========================================
# Range filters
RGBD/LoopClosureReextractFeatures=false  # Don't re-extract on loop closure
RGBD/NeighborLinkRefining=true   # Refine neighbor links
RGBD/ProximityBySpace=true       # Use space for proximity detection
RGBD/ProximityByTime=true        # Use time for proximity detection

# Point cloud filtering
RGBD/AngularUpdate=0.02          # Angular update threshold
RGBD/LinearUpdate=0.05           # Linear update threshold
RGBD/LocalRadius=10.0            # Local radius for mapping
RGBD/ProximityMaxGraphDepth=0    # Max depth for proximity search

# ==========================================
# MAPPING PARAMETERS
# ==========================================
Grid/MaxObstacleHeight=0.5       # Max obstacle height (meters)
Grid/MaxGroundHeight=0.1         # Max ground height (meters)
Grid/DepthDecimation=1           # Depth decimation (1=full resolution)
Grid/RangeMax=4.0                # Max range for mapping (meters)
Grid/RangeMin=0.2                # Min range for mapping (meters)
Grid/RayTracing=true             # Enable ray tracing for cleaner maps
Grid/FootprintLength=0.4         # Robot footprint length
Grid/FootprintWidth=0.3          # Robot footprint width

# ==========================================
# OPTIMIZATION
# ==========================================
RGBD/OptimizeFromGraphEnd=true   # Optimize from graph end
RGBD/OptimizeMaxError=0.5        # Max error for optimization
RGBD/LoopClosureIdentityGuess=false  # Don't use identity guess for loop closure

# ==========================================
# OUTPUT SETTINGS
# ==========================================
Mem/IncrementalMemory=true       # Incremental memory (vs full)
Mem/InitWMWithAllNodes=false     # Don't init working memory with all nodes

